name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: claude-review-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # diff/changed files 분석에 유리

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            1) Use gh to fetch PR title/body/files and the full diff.
            2) (Frontend) Run relevant checks if available: lint, typecheck, test, build.
            3) Leave ONE consolidated review comment (not multiple scattered comments):
               - Blocking / Non-blocking / Nit
               - File-by-file notes
               - Concrete fix suggestions (code snippets OK)
               - React hooks pitfalls, rerender/perf, a11y must be checked

            Use CLAUDE.md for conventions.

          claude_args: >-
            --max-turns 12
            --append-system-prompt "You are a senior React+TypeScript reviewer. Always: (a) identify render/hook pitfalls (deps, stale closure, memoization misuse), (b) check a11y (label/aria/keyboard), (c) call out perf risks (rerenders, expensive computations, list virtualization), (d) require error/loading states for async UI, (e) distinguish Blocking vs Non-blocking."
            --agents '{
              "a11y": {"description":"Accessibility reviewer","prompt":"Review for a11y issues (aria/label/role/keyboard). Provide concrete fixes.","tools":["Read","Grep","Glob","Bash"],"model":"sonnet"},
              "perf": {"description":"Performance reviewer","prompt":"Review for React rendering/bundle/perf issues. Provide measurable suggestions.","tools":["Read","Grep","Glob","Bash"],"model":"sonnet"}
            }'
            --allowed-tools "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(gh pr list:*),Bash(gh issue view:*),Bash(gh search:*),Bash(gh api:*),Bash(npm:*),Bash(npx:*),Bash(pnpm:*),Bash(yarn:*)"